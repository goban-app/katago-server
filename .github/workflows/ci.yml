name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  RUSTUP_MAX_RETRIES: 10

jobs:
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-cache"
      - run: cargo check --all-features

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-cache"
      - run: cargo test --all-features

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: "rust-cache"
      - run: cargo clippy --all-features -- -D warnings

  docker-base:
    name: Build Base Docker Image
    needs: [check, test, fmt, clippy]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.event.head_commit && (contains(join(github.event.head_commit.modified, ','), 'Dockerfile.base') || contains(join(github.event.head_commit.modified, ','), 'Cargo.toml') || contains(join(github.event.head_commit.modified, ','), 'Cargo.lock') || contains(join(github.event.head_commit.modified, ','), 'src/'))
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check if base image needs rebuild
        id: skip_base
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const baseRef = pr ? pr.base.sha : context.payload.before;
            const headRef = pr ? pr.head.sha : context.sha;
            const changed = await github.rest.repos.compareCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              base: baseRef,
              head: headRef
            });
            const files = changed.data.files.map(f => f.filename);
            const needsBuild = files.some(f =>
              f === 'Dockerfile.base' ||
              f === 'Cargo.toml' ||
              f === 'Cargo.lock' ||
              f.startsWith('src/')
            );
            core.setOutput('needs_build', needsBuild);
            if (!needsBuild) {
              core.info('No relevant changes, skipping base image build.');
              core.setOutput('skip', 'true');
            }

      - name: Exit if no base build needed
        if: steps.skip_base.outputs.skip == 'true'
        run: |
          echo "No relevant changes for base image, skipping build."
          exit 0

      - name: Set image name to lowercase
        id: image
        run: echo "name=$(echo 'ghcr.io/${{ github.repository_owner }}/katago-server' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push base image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.base
          push: true
          tags: ${{ steps.image.outputs.name }}:base
          cache-from: type=gha,scope=base
          cache-to: type=gha,mode=max,scope=base
          platforms: linux/amd64,linux/arm64
          provenance: false

  docker-variants:
    name: Build Docker Variants
    needs: docker-base
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write
    
    strategy:
      matrix:
        include:
          - variant: cpu
            dockerfile: Dockerfile
            suffix: ""
            description: "CPU-only with 18-block model"
          - variant: gpu
            dockerfile: Dockerfile.gpu
            suffix: "-gpu"
            description: "GPU-enabled with 40-block model"
          - variant: minimal
            dockerfile: Dockerfile.minimal
            suffix: "-minimal"
            description: "Minimal - bring your own model"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image name to lowercase
        id: image
        run: echo "name=$(echo 'ghcr.io/${{ github.repository_owner }}/katago-server' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.name }}
          flavor: |
            suffix=${{ matrix.suffix }},onlatest=true
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=KataGo Server (${{ matrix.variant }})
            org.opencontainers.image.description=${{ matrix.description }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha,scope=${{ matrix.variant }}
            type=registry,ref=${{ steps.image.outputs.name }}:base
          cache-to: type=gha,mode=max,scope=${{ matrix.variant }}
          platforms: linux/amd64,linux/arm64
          provenance: false
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Generate artifact attestation
        if: steps.meta.outputs.digest != ''
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ${{ steps.image.outputs.name }}
          subject-digest: ${{ steps.meta.outputs.digest }}
          push-to-registry: true
