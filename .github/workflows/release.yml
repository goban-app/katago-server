name: Release

# Tag-based release workflow
#
# This workflow is triggered when you push a version tag (e.g., v0.4.0) and performs:
# 1. Builds and pushes Docker images with the tag version (e.g., 0.4.0, 0.4.0-cpu, etc.)
# 2. Updates Chart.yaml to match the tag version (in-memory, not committed)
# 3. Packages and releases the Helm chart with the same version
# 4. Creates a GitHub release with documentation
#
# Best practices:
# - Tag must follow semantic versioning (X.Y.Z)
# - Chart.yaml version in the repo can be any value (it gets overwritten during release)
# - Docker images and Helm chart versions are always synchronized via the git tag
# - Only tagged releases push Docker images to GHCR (CI builds do not)
#
# To create a release:
#   git tag v0.4.0
#   git push origin v0.4.0

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  attestations: write
  id-token: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ===========================================================================
  # Build and push versioned Docker images
  # ===========================================================================
  docker-release:
    name: Release Docker Image (${{ matrix.variant }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: base
            platforms: linux/amd64,linux/arm64
          - variant: cpu
            platforms: linux/amd64,linux/arm64
          - variant: minimal
            platforms: linux/amd64,linux/arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image name to lowercase
        id: image
        run: echo "name=$(echo 'ghcr.io/${{ github.repository_owner }}/katago-server' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.image.outputs.name }}
          flavor: |
            suffix=${{ matrix.variant == 'base' && '' || format('-{0}', matrix.variant) }},onlatest=true
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest
            type=raw,value=${{ matrix.variant }},enable=${{ matrix.variant == 'base' }}
          labels: |
            org.opencontainers.image.title=KataGo Server (${{ matrix.variant }})
            org.opencontainers.image.description=KataGo Server - ${{ matrix.variant }} variant

      - name: Build and push Docker image
        id: push
        uses: docker/build-push-action@v5
        with:
          context: .
          target: ${{ matrix.variant }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: ${{ matrix.platforms }}
          cache-from: |
            type=gha,scope=${{ matrix.variant }}-${{ github.ref_name }}
            type=gha,scope=${{ matrix.variant }}-main
          cache-to: type=gha,mode=max,scope=${{ matrix.variant }}-${{ github.ref_name }}
          provenance: false
          build-args: |
            GIT_SHA=${{ github.sha }}

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ${{ steps.image.outputs.name }}
          subject-digest: ${{ steps.push.outputs.digest }}
          push-to-registry: true

  # ===========================================================================
  # Release Helm Chart
  # ===========================================================================
  helm-release:
    name: Release Helm Chart
    needs: docker-release  # Wait for Docker images to be available
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Validate semantic versioning format
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?(\+[a-zA-Z0-9.]+)?$'; then
            echo "Error: Tag '$VERSION' is not valid semantic versioning format"
            echo "Expected format: X.Y.Z or X.Y.Z-prerelease or X.Y.Z+build"
            exit 1
          fi

          echo "âœ“ Valid version: $VERSION"

      - name: Update Chart.yaml with tag version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Updating Chart.yaml to version $VERSION"
          sed -i "s/^version: .*/version: $VERSION/" charts/katago-server/Chart.yaml
          sed -i "s/^appVersion: .*/appVersion: \"$VERSION\"/" charts/katago-server/Chart.yaml

          echo "Updated Chart.yaml:"
          cat charts/katago-server/Chart.yaml

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Install chart-releaser
        run: |
          wget https://github.com/helm/chart-releaser/releases/download/v1.6.1/chart-releaser_1.6.1_linux_amd64.tar.gz
          tar -xzf chart-releaser_1.6.1_linux_amd64.tar.gz
          sudo mv cr /usr/local/bin/cr
          cr version

      - name: Package and release Helm chart
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
          CR_OWNER: "${{ github.repository_owner }}"
          CR_GIT_REPO: "${{ github.event.repository.name }}"
        run: |
          # Package the chart
          helm package charts/katago-server -d .cr-release-packages

          # Upload the chart to GitHub releases
          cr upload --skip-existing

          # Update the index
          cr index --push

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  github-release:
    name: Create GitHub Release
    needs: [docker-release, helm-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.version.outputs.version }}
          generate_release_notes: true
          body: |
            ## Docker Images

            This release includes the following Docker images:

            - `ghcr.io/stubbi/katago-server:${{ steps.version.outputs.version }}` (CPU variant - default)
            - `ghcr.io/stubbi/katago-server:${{ steps.version.outputs.version }}-minimal` (Minimal variant - BYO KataGo)
            - `ghcr.io/stubbi/katago-server:${{ steps.version.outputs.version }}-base` (Base variant - binary only)

            All images are available for `linux/amd64` and `linux/arm64` platforms.

            ## Helm Chart

            Install the Helm chart for this release:

            ```bash
            helm repo add katago-server https://stubbi.github.io/katago-server
            helm repo update
            helm install my-katago katago-server/katago-server --version ${{ steps.version.outputs.version }}
            ```

            Or use the Docker images directly:

            ```bash
            docker pull ghcr.io/stubbi/katago-server:${{ steps.version.outputs.version }}
            docker run -p 2718:2718 ghcr.io/stubbi/katago-server:${{ steps.version.outputs.version }}
            ```

            ## What's Changed

            See the auto-generated release notes below for detailed changes.
